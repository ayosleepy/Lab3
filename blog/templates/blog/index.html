{% extends 'blog/base.html' %}

{% block content %}
<div class="card">
    <h2>Главная страница</h2>
    <p>Последние посты сообщества</p>
</div>

{% if user.is_authenticated %}
<div class="card">
    <form action="{% url 'create_post' %}" method="get">
        <textarea name="content" rows="3" placeholder="Что у вас нового?" style="width: 100%;"></textarea>
        <button type="submit" class="btn btn-success">Опубликовать</button>
    </form>
</div>
{% endif %}

{% for post in posts %}
<div class="card">
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <div>
            <strong>{{ post.author.username }}</strong>
            <small style="color: #666;">{{ post.created_at|date:"d.m.Y H:i" }}</small>
        </div>
        {% if user == post.author %}
        <div>
            <a href="{% url 'edit_post' post.id %}" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Изменить</a>
            <a href="{% url 'delete_post' post.id %}" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">Удалить</a>
        </div>
        {% endif %}
    </div>
    
    <p>{{ post.content }}</p>
    
    <div style="margin-top: 15px; display: flex; gap: 15px; color: #666;">
        <form action="{% url 'like_post' post.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn" style="padding: 5px 10px;">
                {% if user in post.likes.all %}Не нравится{% else %}Нравится{% endif %} {{ post.likes_count }}
            </button>
        </form>
        <span>Комментарии: {{ post.comments_count }}</span>
    </div>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
        <form action="{% url 'add_comment' post.id %}" method="post">
            {% csrf_token %}
            <textarea name="content" rows="2" placeholder="Добавить комментарий..." required style="width: 100%;"></textarea>
            <button type="submit" class="btn btn-secondary" style="padding: 5px 15px;">Отправить</button>
        </form>
        
        {% for comment in post.comments.all|slice:":3" %}
        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <strong>{{ comment.user.username }}</strong>
                    <small style="color: #666;">{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                </div>
                {% if user == comment.user %}
                <div>
                    <a href="{% url 'edit_comment' comment.id %}" style="color: #666; text-decoration: none; margin-right: 10px;">Изменить</a>
                    <a href="{% url 'delete_comment' comment.id %}" style="color: #dc3545; text-decoration: none;">Удалить</a>
                </div>
                {% endif %}
            </div>
            <p style="margin-top: 5px;">{{ comment.content }}</p>
        </div>
        {% endfor %}
        
        {% if post.comments_count > 3 %}
        <div style="margin-top: 10px;">
            <a href="#" style="color: #007bff; text-decoration: none;">Показать все комментарии ({{ post.comments_count }})</a>
        </div>
        {% endif %}
    </div>
</div>
{% empty %}
<div class="card">
    <p>Пока нет постов. Будьте первым!</p>
</div>
{% endfor %}

{% if posts.has_other_pages %}
<div class="card" style="text-align: center;">
    <div style="display: inline-block;">
        {% if posts.has_previous %}
        <a href="?page={{ posts.previous_page_number }}" class="btn btn-secondary">Назад</a>
        {% endif %}
        
        <span style="margin: 0 15px;">Страница {{ posts.number }} из {{ posts.paginator.num_pages }}</span>
        
        {% if posts.has_next %}
        <a href="?page={{ posts.next_page_number }}" class="btn btn-secondary">Вперед</a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}