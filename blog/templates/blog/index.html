{% extends 'blog/base.html' %}

{% block content %}
<div class="box">
    <h2 style="margin-top: 0;">Главная</h2>
    <p>Лента постов</p>
</div>

{% if user.is_authenticated %}
<div class="box">
    <form action="{% url 'create_post' %}" method="get">
        <textarea name="content" rows="3" placeholder="Что нового?" style="width: 100%;"></textarea>
        <button type="submit" class="btn btn-green">Опубликовать</button>
    </form>
</div>
{% endif %}

{% for post in posts %}
<div class="box">
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <div>
            <strong>{{ post.author.username }}</strong>
            <span class="small-text">{{ post.created_at|date:"d.m.Y H:i" }}</span>
        </div>
        {% if user == post.author %}
        <div>
            <a href="{% url 'edit_post' post.id %}" class="btn btn-gray" style="padding: 4px 8px; font-size: 12px;">Изм</a>
            <a href="{% url 'delete_post' post.id %}" class="btn btn-red" style="padding: 4px 8px; font-size: 12px;">Удл</a>
        </div>
        {% endif %}
    </div>

    <p style="margin: 15px 0;">{{ post.content }}</p>

    <div style="margin-top: 12px; display: flex; gap: 15px; color: #65676b;">
        <form action="{% url 'like_post' post.id %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn" style="padding: 4px 10px;">
                {% if user in post.likes.all %}Не нравится{% else %}Нравится{% endif %} {{ post.likes_count }}
            </button>
        </form>
        <span>Комментарии: {{ post.comments_count }}</span>
    </div>

    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dddfe2;">
        <form action="{% url 'add_comment' post.id %}" method="post">
            {% csrf_token %}
            <textarea name="content" rows="2" placeholder="Ваш комментарий..." required style="width: 100%;"></textarea>
            <button type="submit" class="btn btn-gray" style="padding: 5px 12px;">Отправить</button>
        </form>

        {% for comment in post.comments.all|slice:":3" %}
        <div style="margin-top: 10px; padding: 8px; background: #f0f2f5; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between;">
                <div>
                    <strong>{{ comment.user.username }}</strong>
                    <span class="small-text">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                {% if user == comment.user %}
                <div>
                    <a href="{% url 'edit_comment' comment.id %}" class="small-text" style="margin-right: 8px;">Изм</a>
                    <a href="{% url 'delete_comment' comment.id %}" class="small-text" style="color: #e41e3f;">Удл</a>
                </div>
                {% endif %}
            </div>
            <p style="margin-top: 5px;">{{ comment.content }}</p>
        </div>
        {% endfor %}

        {% if post.comments_count > 3 %}
        <div style="margin-top: 10px;">
            <a href="#" class="small-text">Еще комментарии ({{ post.comments_count }})</a>
        </div>
        {% endif %}
    </div>
</div>
{% empty %}
<div class="box">
    <p>Пока нет постов</p>
</div>
{% endfor %}

{% if posts.has_other_pages %}
<div class="box" style="text-align: center;">
    <div style="display: inline-block;">
        {% if posts.has_previous %}
        <a href="?page={{ posts.previous_page_number }}" class="btn btn-gray">Назад</a>
        {% endif %}

        <span style="margin: 0 12px;">{{ posts.number }} / {{ posts.paginator.num_pages }}</span>

        {% if posts.has_next %}
        <a href="?page={{ posts.next_page_number }}" class="btn btn-gray">Вперед</a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}