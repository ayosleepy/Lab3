{% extends 'blog/base.html' %}

{% block content %}
<div class="box">
    <h2>Главная</h2>
    <p>Лента постов</p>
</div>

{% if user.is_authenticated %}
<div class="box">
    <form action="{% url 'create_post' %}" method="get">
        <textarea name="content" rows="3" placeholder="Что нового?"></textarea>
        <button type="submit" class="btn btn-green">Опубликовать</button>
    </form>
</div>
{% endif %}

{% for post in posts %}
<div class="box">
    <div class="post-header">
        <div class="post-meta">
            <strong>{{ post.author.username }}</strong>
            <span class="small-text">{{ post.created_at|date:"d.m.Y H:i" }}</span>
        </div>
        {% if user == post.author %}
        <div class="post-actions">
            <a href="{% url 'edit_post' post.id %}" class="btn btn-gray small-btn">Изменить</a>
            <a href="{% url 'delete_post' post.id %}" class="btn btn-red small-btn">Удалить</a>
        </div>
        {% endif %}
    </div>

    <p class="post-content">{{ post.content }}</p>

    <div class="post-stats">
        <form action="{% url 'like_post' post.id %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn">
                {% if user in post.likes.all %}Не нравится{% else %}Нравится{% endif %} {{ post.likes_count }}
            </button>
        </form>
        <span>Комментарии: {{ post.comments_count }}</span>
    </div>

    <div class="comments-section">
        <form action="{% url 'add_comment' post.id %}" method="post" class="comment-form">
            {% csrf_token %}
            <textarea name="content" rows="2" placeholder="Ваш комментарий..." required></textarea>
            <button type="submit" class="btn btn-gray">Отправить</button>
        </form>

        {% for comment in post.comments.all|slice:":3" %}
        <div class="comment-item">
            <div class="comment-header">
                <div>
                    <strong>{{ comment.user.username }}</strong>
                    <span class="small-text">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
                </div>
                {% if user == comment.user %}
                <div class="comment-actions">
                    <a href="{% url 'edit_comment' comment.id %}" class="small-text">Изменить</a>
                    <a href="{% url 'delete_comment' comment.id %}" class="warning-text">Удалить</a>
                </div>
                {% endif %}
            </div>
            <p class="comment-text">{{ comment.content }}</p>
        </div>
        {% endfor %}

        {% if post.comments_count > 3 %}
        <div>
            <a href="#" class="small-text">Еще комментарии ({{ post.comments_count }})</a>
        </div>
        {% endif %}
    </div>
</div>
{% empty %}
<div class="box">
    <p>Пока нет постов</p>
</div>
{% endfor %}

{% if posts.has_other_pages %}
<div class="box pagination">
    <div class="pagination-controls">
        {% if posts.has_previous %}
        <a href="?page={{ posts.previous_page_number }}" class="btn btn-gray">Назад</a>
        {% endif %}

        <span class="pagination-info">{{ posts.number }} / {{ posts.paginator.num_pages }}</span>

        {% if posts.has_next %}
        <a href="?page={{ posts.next_page_number }}" class="btn btn-gray">Вперед</a>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}